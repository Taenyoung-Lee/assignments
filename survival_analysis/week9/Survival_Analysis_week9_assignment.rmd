---
title: "Survival_Analysis_week9"
author: "202430527 leetaenyoung"
date: "2025-11-02"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float: true
    df_print: paged
    code_folding: hide
    theme: readable
fontsize: 11pt
geometry: margin=1in
always_allow_html: true
---

# Week 9 assignment

## Data-Library import 및 기본 전처리

```{r import-data-library}
library(survival)
vets <- read.table("vets.txt", header = TRUE) 
```

```{r preprocessing-common}
# 1. Surv 객체 생성
Sobj <- with(vets, Surv(time, status == 1))

# 2. PS 변수 이분화
vets$PS_high <- as.integer(vets$PS >= 50)
vets$PS_grp  <- factor(vets$PS_high, levels = c(0,1),
                       labels = c("Low (<50)", "High (≥50)"))

# 3. 'celltype' 변수 생성
vets$celltype_num <- ifelse(vets$CT1 == 1, 1,
                       ifelse(vets$CT2 == 1, 2,
                          ifelse(vets$CT3 == 1, 3, 4)))

# 4. 새로 만든 숫자형 변수를 팩터(factor)로 변환
vets$celltype <- factor(vets$celltype_num, levels = 1:4,
                        labels = c("squamous", "smallcell", "adeno", "large"))

# 5. 'trt' 변수 생성 
vets$trt <- factor(vets$Trt, levels = c(1, 2),
                   labels = c("standard", "test"))
```

-----

## Question 1. Goodness-of-fit test

  * `vets` 데이터의 주요 변수들(`trt`, `age`, `PS_grp`, `celltype`)에 대해 비례위험(PH) 가정을 확인하는 Goodness-of-fit test (Schoenfeld residual test)를 수행합니다.

```{r q1-gof-test}
# 1. 먼저 모든 변수를 포함하는 Cox 모델을 적합합니다.
fit_full <- coxph(Sobj ~ trt + age + PS_grp + celltype, data = vets)

summary(fit_full)

# 2. cox.zph() 함수를 사용하여 PH 가정을 검정합니다.
ph_test_full <- cox.zph(fit_full)
print(ph_test_full)
```

### Conclusion

  * cox.zph 검정 결과, trt (p=0.836)와 age (p=0.422) 변수는 비례위험(PH) 가정을 만족합니다.
  * PS_grp (p=0.00082)와 celltype (p=0.00849) 변수는 p-value가 0.05보다 작아 PH 가정을 위반합니다.
  * GLOBAL p-value (8.5e-05) 역시 유의하여, 이 모델 전체는 PH 가정을 만족하지 못합니다. (PH 가정을 위반한 PS_grp와 celltype을 층화 변수(strata)로 사용하는 근거가 됩니다.)

-----

## Question 2. Z\* 변수 생성

  * `celltype` (4개 범주)과 `PS_grp` (2개 범주) 변수로부터 8개의 카테고리를 가지는 `Z*` 변수를 생성합니다.

```{r q2-create-zstar}
# R의 interaction() 함수를 사용하면 두 팩터 변수의 조합으로 
# 새로운 팩터 변수를 쉽게 생성할 수 있습니다.
vets$Z_star <- interaction(vets$celltype, vets$PS_grp, sep = " - ")

table(vets$Z_star)
```

### Conclusion

  * `celltype`의 4개 수준과 `PS_grp`의 2개 수준이 조합되어 총 8개 범주(4 x 2 = 8)를 갖는 `Z_star` 변수가 생성되었습니다.

-----

## Question 3. Stratified Cox (SC) model (No interaction)

  * `Z*` 변수를 층(strata)으로 하는 Stratified Cox model을 적합합니다.
  * 모델에는 `treatment status` (trt)와 `age` 변수만 공변량으로 포함합니다. (상호작용 없음)


```{r q3-sc-no-interaction}
# strata() 함수를 사용하여 Z_star를 층화 변수로 지정합니다.
fit_sc_no_inter <- coxph(Sobj ~ trt + age + strata(Z_star), data = vets)

summary(fit_sc_no_inter)
```

### Conclusion

  * Z_star의 8개 층(strata)별로 서로 다른 기저위험함수(baseline hazard)를 가정하는 층화 콕스 모델을 적합했습니다.
  * 모델에 포함된 공변량 trt (p=0.747)와 age (p=0.994)는 유의수준 0.05에서 생존에 유의미한 영향을 미치지 않는 것으로 나타났습니다.
  * trt의 HR은 1.071, age의 위험비HR은 0.9999로 둘다 모두 1에 매우 가깝습니다.

-----

## Question 4. Stratified Cox (SC) model (Interaction)

  * `Z*` 변수를 층(strata)으로 하는 Stratified Cox model을 적합합니다.
  * 모델에는 `trt`, `age` 및 두 변수 간의 **상호작용(interaction)** 항을 포함합니다.


```{r q4-sc-interaction}
# trt:age 를 사용하여 상호작용 항을 추가합니다.
fit_sc_inter <- coxph(Sobj ~ trt + age + trt:age + strata(Z_star), 
                      data = vets)

summary(fit_sc_inter)
```

### Conclusion

  * `trt`와 `age` 간의 상호작용 항(`trt:age`)을 추가한 SC 모델을 적합했습니다.
  * 상호작용 항 trt:age의 p-value는 0.747로 통계적으로 유의하지 않았습니다.
  * 이는 age가 생존에 미치는 영향이 trt 그룹(standard vs test)에 따라 유의미하게 달라지지 않음을 의미합니다.

-----

## Question 5. Model Comparison (LR test)

  * Q3의 모델(No interaction)과 Q4의 모델(Interaction)을 비교하기 위해 Likelihood Ratio (LR) test를 수행합니다.

```{r q5-lr-test}
# 두 모델은 anova() 함수로 LR test를 수행할 수 있습니다.
lr_test_result <- anova(fit_sc_no_inter, fit_sc_inter)

print(lr_test_result)
```

### Conclusion

  * LR test는 두 모델 간에 상호작용 항(`trt:age`)을 추가하는 것이 통계적으로 유의미한지 검정합니다.
  * 검정 결과 P(>|Chi|) 값이 0.747로 유의수준 0.05보다 매우 큽니다.
  * 따라서 상호작용 항을 추가하는 것이 모델의 적합도를 유의미하게 향상시키지 못하므로, 더 간명한 모델인 Q3의 'No interaction' 모델을 선택하는 것이 타당합니다.

-----

-----


[![View on GitHub](https://img.shields.io/badge/GitHub-Repository-blue?logo=github)](https://github.com/Taenyoung-Lee/assignments/blob/main/survival_analysis/week7/Survival_Analysis_week9_assignment.rmd)


