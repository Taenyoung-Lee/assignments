---
title: "강릉강수량량"
author: "Taenyoung Lee"
date: "2025-11-24"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float: true
    df_print: paged
    code_folding: hide
    theme: readable
fontsize: 11pt
geometry: margin=1in
always_allow_html: true
---

## libaray 호출 및 전처리

```{r}
#### 0) 패키지 -------------------------------------------------------------------

library(readr)
library(dplyr)
library(lubridate)
library(stringr)
library(zoo)
library(forecast)
library(tseries)
library(ggplot2)

#### 1) 파일 경로 ----------------------------------------------------------------
in_path <- "C:/Users/Tae/Downloads/강릉강수량_s.csv"  

#### 2) CSV 읽기 (EUC-KR) -------------------------------------------------------
df_raw <- readr::read_csv(
  file = in_path,
  locale = locale(encoding = "EUC-KR"),
  show_col_types = FALSE
)



#### 3) 열 매핑: '일시'와 강수량 열 ------------------------------------------------
# 일시 후보
date_candidates <- c("일시","날짜","date","DATE","Date")
date_col <- intersect(date_candidates, names(df_raw))[1]
if (is.na(date_col)) stop("날짜/일시 열을 찾지 못했습니다. (예: '일시', '날짜', 'date')")

# 강수량 후보
prec_candidates <- c("강수량(mm)","강수량","precip","rain")
prec_col <- intersect(prec_candidates, names(df_raw))[1]
if (is.na(prec_col)) stop("강수량 열을 찾지 못했습니다. (예: '강수량(mm)', '강수량', 'precip')")

# 작업용 데이터
df <- df_raw %>%
  rename(datetime_kr = !!date_col,
         precip_raw  = !!prec_col)

#### 4) '1911년 10월' 형식 파서 ---------------------------------------------------

parse_year_month_kr <- function(x) {
  s <- trimws(as.character(x))

  yr <- suppressWarnings(as.integer(str_match(s, "([0-9]{3,4})\\s*년")[,2]))
  mo <- suppressWarnings(as.integer(str_match(s, "([0-9]{1,2})\\s*월")[,2]))

  # 비정상 값 처리
  yr[is.na(yr) | yr < 0] <- NA_integer_
  mo[is.na(mo) | mo < 1 | mo > 12] <- NA_integer_

  # 날짜 문자열 만들기
  out <- ifelse(!is.na(yr) & !is.na(mo),
                sprintf("%04d-%02d-01", yr, mo),
                NA_character_)
  as.Date(out)
}

# 변환 실행
df$date <- parse_year_month_kr(df$datetime_kr)

# 변환 결과 점검
if (any(is.na(df$date))) {
  warning(sprintf("날짜 변환 실패 %d건이 있습니다. (총 %d건)",
                  sum(is.na(df$date)), nrow(df)))
}

#### 5) 강수량 숫자화 및 월 집계 ---------------------------------------------------
# - 동일 월에 다수 관측치가 있으면 합계(원자료가 월별 1개면 합계=원값)
df <- df %>%
  mutate(precip = suppressWarnings(as.numeric(precip_raw))) %>%
  filter(!is.na(date), !is.na(precip)) %>%
  mutate(month_start = floor_date(date, "month")) %>%
  group_by(month_start) %>%
  summarise(precip = sum(precip, na.rm = TRUE), .groups = "drop") %>%
  arrange(month_start) %>%
  rename(date = month_start)

stopifnot(nrow(df) > 0)

cat(sprintf("데이터 범위: %s ~ %s, 관측치: %d\n",
            format(min(df$date), "%Y-%m"), format(max(df$date), "%Y-%m"), nrow(df)))
```

## 원자료시각화

```{r}
#### 6) 원자료 시각화 -------------------------------------------------------------
ggplot(df, aes(x = date, y = precip)) +
  geom_line() +
  labs(
    title = "강릉 월별 강수량(원자료)",
    x = sprintf("날짜 (%s - %s)",
                format(min(df$date), "%Y.%m"),
                format(max(df$date), "%Y.%m")),
    y = "강수량 (mm)"
  )
```

## 시계열 전처리

```{r}
#### 7) ts 객체(frequency=12) -----------------------------------------------------
start_year <- year(min(df$date)); start_mon <- month(min(df$date))
end_year   <- year(max(df$date)); end_mon   <- month(max(df$date))

y <- ts(df$precip,
        start = c(start_year, start_mon),
        end   = c(end_year,   end_mon),
        frequency = 12)

# 확인
start(y); end(y); frequency(y)
```

## ACF plot

```{r}
#### 8) 정상성(시각적 점검): ACF/PACF 플롯 -----------------------------------------
# 필요 패키지: forecast, ggplot2 (이미 로드되어 있다고 가정)
# 원시계열 ACF/PACF
p_acf_orig  <- ggAcf(y, lag.max = 48) + ggtitle("ACF: 원자료 y")
p_pacf_orig <- ggPacf(y, lag.max = 48) + ggtitle("PACF: 원자료 y")
print(p_acf_orig); print(p_pacf_orig)

# 계절차분(12) 후 ACF/PACF
y_seasonal_diff <- diff(y, lag = 12)
p_acf_seas  <- ggAcf(y_seasonal_diff, lag.max = 48) + ggtitle("ACF: 12-계절차분 후")
p_pacf_seas <- ggPacf(y_seasonal_diff, lag.max = 48) + ggtitle("PACF: 12-계절차분 후")
print(p_acf_seas); print(p_pacf_seas)
```


## AIC 그리드서치치

```{r}
#### 9) AIC 그리드 탐색 (p=0..3, q=0..3, P=0..2, Q=0..2) ------------------------
grid <- expand.grid(p = 0:3, q = 0:3, P = 0:2, Q = 0:2, KEEP.OUT.ATTRS = FALSE) |>
  dplyr::filter(!(p == 0 & q == 0 & P == 0 & Q == 0))

get_aic <- function(p, q, P, Q, include_mean = TRUE) {
  fit <- try(
    Arima(y,
          order    = c(p, 0, q),
          seasonal = list(order = c(P, 1, Q), period = 12),
          include.mean = include_mean,
          method   = "ML"),
    silent = TRUE
  )
  if (inherits(fit, "try-error")) return(Inf)
  AIC(fit)
}

grid$AIC <- apply(grid, 1, function(r)
  get_aic(r[["p"]], r[["q"]], r[["P"]], r[["Q"]], include_mean = TRUE))

grid_sorted <- grid |> arrange(AIC)
head(grid_sorted, 5)
```

## 최종모형적합

```{r}
#### 10) 최종 모형 적합: (2,0,2)×(0,1,1)[12] -------------------------------------
# SAS와와 동일 모델 두 가지(절편 포함/제외) 비교
fit_with_int <- Arima(y,
                      order    = c(2, 0, 2),
                      seasonal = list(order = c(0, 1, 1), period = 12),
                      include.mean = TRUE,
                      method   = "ML")

fit_no_int <- Arima(y,
                    order    = c(2, 0, 2),
                    seasonal = list(order = c(0, 1, 1), period = 12),
                    include.mean = FALSE,
                    method   = "ML")

fit_with_int
fit_no_int

```

## 잔차진단

```{r}
#### 11) 잔차 진단 ---------------------------------------------------------------
#res_with <- residuals(fit_with_int)
res_no   <- residuals(fit_no_int)

# (a) 잔차 시계열
#autoplot(res_with) + ggtitle("Residuals (with intercept)") + ylab("Residual")
autoplot(res_no)   + ggtitle("Residuals (no intercept)")   + ylab("Residual")

# (b) 잔차 ACF/PACF
#ggAcf(res_with, lag.max = 24) + ggtitle("ACF of residuals (with intercept)")
#ggPacf(res_with, lag.max = 24) + ggtitle("PACF of residuals (with intercept)")
ggAcf(res_no, lag.max = 24) + ggtitle("ACF of residuals (no intercept)")
ggPacf(res_no, lag.max = 24) + ggtitle("PACF of residuals (no intercept)")

# (c) 포트맨토(Ljung-Box) — 자유도 p+q+P+Q
#Box.test(res_with, lag = 24, type = "Ljung-Box", fitdf = 2 + 2 + 0 + 1)
Box.test(res_no,   lag = 24, type = "Ljung-Box", fitdf = 2 + 2 + 0 + 1)

# (d) 종합 점검
#checkresiduals(fit_with_int)
checkresiduals(fit_no_int)

```

## 12개월 forecast

```{r}
#### 12) 12개월 예측 및 플롯 -----------------------------------------------------
#fc_with <- forecast(fit_with_int, h = 12)
fc_no   <- forecast(fit_no_int,   h = 12)

#autoplot(fc_with) + ggtitle("Forecast: (2,0,2)×(0,1,1)[12] (with intercept)")
autoplot(fc_no)   + ggtitle("Forecast: (2,0,2)×(0,1,1)[12] (no intercept)")

# 예측표 확인
#head(as.data.frame(fc_with))
head(as.data.frame(fc_no))
``` 

## 시계열 이상치 탐지 + 그래프에 표시

```{r}
## 13) tsoutliers로 이상치 탐지 ----------------------------------------------
# (이미 library(forecast)는 로드된 상태)

# y : 이전에 만든 monthly ts 객체
out_ts <- tsoutliers(y)
out_ts            # 어떤 시점이 이상치인지 확인
# out_ts$index      # 시계열 index (정수 위치)
# out_ts$replacement # 대체값(이상치 교정용), 필요하면 사용

library(tsoutliers)
out_ts_tso <- tso(y, cval = 3.5)


# df에 인덱스와 이상치 플래그 추가
df <- df %>%
  mutate(idx        = row_number(),
         is_out_ts  = idx %in% out_ts_tso$outliers$ind)

# 이상치에 해당하는 월만 테이블로 확인
df %>%
  filter(is_out_ts) %>%
  select(date, precip)
## 13-1) 이상치 표시된 원자료 플롯 -------------------------------------------
library(ggrepel)

ggplot(df, aes(x = date, y = precip)) +
  geom_line() +
  geom_point(data = df %>% filter(is_out_ts),
             aes(x = date, y = precip),
             color = "red", size = 2) +
  geom_text_repel(
    data = df %>% filter(is_out_ts),
    aes(label = format(date, "%Y-%m")),
    size = 3
  ) +
  labs(
    title = "강릉 월별 강수량 (이상치 라벨 포함)",
    x = "날짜",
    y = "강수량(mm)"
  )

```




## 계절더미 (regression + Arima)

```{r}
## 14) 계절 더미변수 생성 -----------------------------------------------------
# y : 월별 ts, frequency = 12
X_season <- seasonaldummy(y)  # n x 11 matrix, 마지막 달(예: 12월)이 기준범주

dim(X_season)
head(X_season)

```

## 분석

```{r}
## 14-1) SARIMA(2,0,2)(0,1,1)[12] + 계절더미 -------------------------------
fit_sarima_seas <- Arima(
  y,
  order    = c(2, 0, 2),
  seasonal = list(order = c(0, 1, 1), period = 12),
  xreg     = X_season,
  include.mean = TRUE,   # seasonaldummy가 11개라 intercept와 같이 써도 됨
  method   = "ML"
)

fit_sarima_seas
AIC(fit_no_int); AIC(fit_sarima_seas)
BIC(fit_no_int); BIC(fit_sarima_seas)

```

### 잔차진단

```{r}
checkresiduals(fit_sarima_seas)

```


## 계절더미 + ARMA

```{r}
## 14-2) ARIMA(2,0,2) + 계절 더미 (RegARIMA) -------------------------------
fit_reg_seas <- Arima(
  y,
  order    = c(2, 0, 2),
  seasonal = list(order = c(0, 0, 0), period = 12),  # 계절 ARIMA는 꺼둠
  xreg     = X_season,
  include.mean = TRUE,
  method   = "ML"
)

fit_reg_seas
AIC(fit_reg_seas); BIC(fit_reg_seas)

checkresiduals(fit_reg_seas)

```


## 계절더미 예측
```{r}
## 14-3) 계절더미 모형으로 12개월 예측 --------------------------------------
# 12개월에 대한 계절 더미 (예측용)
X_season_future <- seasonaldummy(y, h = 12)

# (a) SARIMA + 계절더미 모형의 예측
fc_sarima_seas <- forecast(
  fit_sarima_seas,
  xreg = X_season_future  # h는 nrow(X_season_future)에서 자동 추론
)

autoplot(fc_sarima_seas) +
  ggtitle("Forecast: SARIMA + seasonal dummy (12-step ahead)")

# (b) ARIMA(2,0,2) + 계절더미 모형의 예측
fc_reg_seas <- forecast(
  fit_reg_seas,
  xreg = X_season_future
)

autoplot(fc_reg_seas) +
  ggtitle("Forecast: ARIMA(2,0,2) + seasonal dummy (12-step ahead)")

# 예측 수치 확인
head(as.data.frame(fc_reg_seas))
```



## 조건부 저강수 월 탐지(SARIMA)

```{r}
library(zoo)   # as.yearmon

# 1) fitted 값(조건부 예측값)과 잔차
fitted_vals <- fitted(fit_no_int)              # E(y_t | 과거)

res         <- y - fitted_vals                 # 잔차
sigma_hat   <- sqrt(fit_no_int$sigma2)         # 예측오차 표준편차 (근사)
z_t         <- as.numeric(res / sigma_hat)     # 조건부 표준화 잔차

# 2) ts의 time index -> Date로 변환
dates_ts <- as.Date(as.yearmon(time(y)))       # y와 동일 길이

# 3) tibble 생성
k <- 1.5  # drought threshold (1.0, 1.5, 2.0 등 조절 가능)

df_cond <- tibble(
  date    = dates_ts,
  precip  = as.numeric(y),
  fitted  = as.numeric(fitted_vals),
  z_cond  = z_t,
  dry_cond = z_t < -k
)

```

dry_cond == TRUE인 달은

“SARIMA가 기대한 값보다 kσ 이상 적게 온 달”

이라고 해석하면 됩니다.

```{r}
# (1) 조건부 z-score 시계열
ggplot(df_cond, aes(x = date, y = z_cond)) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -k, linetype = "dashed") +
  geom_line() +
  geom_point(
    data = df_cond %>% filter(dry_cond),
    color = "red", size = 2
  ) +
  labs(
    title = sprintf("조건부 표준화 잔차 (z < %.1f 인 달을 건조로 표시)", -k),
    x = "날짜",
    y = "조건부 z-score"
  )

# (2) 원 강수량 위에 표시
library(ggrepel)

ggplot(df_cond, aes(x = date, y = precip)) +
  geom_line() +
  geom_point(
    data = df_cond %>% filter(dry_cond),
    color = "red", size = 2
  ) +
  geom_text_repel(
    data = df_cond %>% filter(dry_cond),
    aes(label = format(date, "%Y-%m")),
    size = 3
  ) +
  labs(
    title = "강릉 월별 강수량 - SARIMA 조건부 기준 저강수 달 표시",
    x = "날짜",
    y = "강수량(mm)"
  )

```




## 조건부 저강수 월 탐지(ARMA+계절더미미)

```{r}
library(zoo)   # as.yearmon

# 1) fitted 값(조건부 예측값)과 잔차
              # E(y_t | 과거)
fitted_vals <- fitted(fit_reg_seas)
res         <- y - fitted_vals                 # 잔차
sigma_hat   <- sqrt(fit_no_int$sigma2)         # 예측오차 표준편차 (근사)
z_t         <- as.numeric(res / sigma_hat)     # 조건부 표준화 잔차

# 2) ts의 time index -> Date로 변환
dates_ts <- as.Date(as.yearmon(time(y)))       # y와 동일 길이

# 3) tibble 생성
k <- 1.5  # drought threshold (1.0, 1.5, 2.0 등 조절 가능)

df_cond <- tibble(
  date    = dates_ts,
  precip  = as.numeric(y),
  fitted  = as.numeric(fitted_vals),
  z_cond  = z_t,
  dry_cond = z_t < -k
)

```

dry_cond == TRUE인 달은

“SARIMA가 기대한 값보다 kσ 이상 적게 온 달”

이라고 해석하면 됩니다.

```{r}
# (1) 조건부 z-score 시계열
ggplot(df_cond, aes(x = date, y = z_cond)) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -k, linetype = "dashed") +
  geom_line() +
  geom_point(
    data = df_cond %>% filter(dry_cond),
    color = "red", size = 2
  ) +
  labs(
    title = sprintf("조건부 표준화 잔차 (z < %.1f 인 달을 건조로 표시)", -k),
    x = "날짜",
    y = "조건부 z-score"
  )

# (2) 원 강수량 위에 표시
library(ggrepel)

ggplot(df_cond, aes(x = date, y = precip)) +
  geom_line() +
  geom_point(
    data = df_cond %>% filter(dry_cond),
    color = "red", size = 2
  ) +
  geom_text_repel(
    data = df_cond %>% filter(dry_cond),
    aes(label = format(date, "%Y-%m")),
    size = 3
  ) +
  labs(
    title = "강릉 월별 강수량 - ARMA+계절더미미 조건부 기준 저강수 달 표시",
    x = "날짜",
    y = "강수량(mm)"
  )

```


